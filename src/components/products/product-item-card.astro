---
import { ProductCardActions } from '@/components/products/product-card-actions';
import ProductCarousel from '@/components/products/product-carousel';
import { Button } from '@/components/ui/button';
import { productSlug } from '@/lib/utils';
import { ArrowRight, Ruler, Weight } from 'lucide-react';
import { type ProductData } from './types';

interface Props {
  index: number
  productData: ProductData;
  lang?: string;
};

import { ui, useTranslations } from '@/i18n/ui'; // Import i18n utils
import { getLocalizedRoute } from '@/i18n/utils';

const { index, productData, lang = 'en' } = Astro.props;
const t = useTranslations(lang as keyof typeof ui);

// Use slug from data if available, fallback to generated (which might be wrong if localized name)
const slug = productData.slug || productSlug(productData.name);
const productLink = getLocalizedRoute(`/products/${slug}`, lang);

// Construct full image URL for Supabase Storage
const firstImage = productData.images?.[0];
let productImageUri = '';

if (firstImage) {
  if (firstImage.startsWith('http')) {
     productImageUri = firstImage;
  } else {
     productImageUri = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/products/${firstImage}`;
  }
}

const itemAnimationDelay = (index: number) => {
  return index * 100; // Simplified delay
}
---

<div 
  class="group flex flex-col bg-white rounded-xl border border-zinc-200 overflow-hidden hover:shadow-lg hover:border-blue-200 transition-all duration-300 animate-fadein-up" 
  style={{animationDelay: `${itemAnimationDelay(index)}ms`}}
>
  {/* Image Area - Aspect Ratio Box */}
  <div class="relative w-full aspect-4/3 bg-zinc-50 p-6 flex items-center justify-center border-b border-zinc-100 group-hover:bg-white transition-colors">
    <div class="relative w-full h-full">
      <ProductCarousel client:visible
        productImageUris={[productImageUri]}
        className='w-full h-full object-contain mix-blend-multiply'
      />
    </div>
    
    {/* Action Buttons Overlay */}
    <div class="absolute bottom-3 right-3 z-10 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
       <ProductCardActions client:visible product={{ name: productData.name, image: productImageUri }} />
    </div>
  </div>

  {/* Content Area */}
  <div class="flex flex-col flex-grow p-5">
    <h3 class="text-lg font-bold text-zinc-900 group-hover:text-blue-700 transition-colors line-clamp-1 mb-2">
      <a href={productLink} class="hover:underline">
        {productData.name}
      </a>
    </h3>
    
    <p class="text-sm text-zinc-500 line-clamp-2 mb-4 flex-grow h-10">
      {productData.description}
    </p>

    {/* Mini Specs Grid */}
    <div class="grid grid-cols-2 gap-2 mb-5 py-3 border-y border-zinc-50">
      <div class="flex items-center text-xs text-zinc-500">
        <Ruler className="w-3 h-3 mr-1.5 text-zinc-400" />
        <span class="truncate">{t('custom-dimensions') || 'Custom Dimensions'}</span>
      </div>
      {
        productData.specs.weight && (
          <div class="flex items-center text-xs text-zinc-500">
            <Weight className="w-3 h-3 mr-1.5 text-zinc-400" />
            <span class="truncate">{productData.specs.weight.value.toFixed(1)} kg</span>
          </div>
        )
      }
    </div>

    {/* Action */}
    <a href={productLink} class="mt-auto">
      <Button variant="outline" className="w-full justify-between hover:bg-blue-50 hover:text-blue-700 hover:border-blue-200 group-hover:border-blue-200 transition-all">
        <span class="text-xs font-medium uppercase tracking-wide">{t('view-specs') || 'View Specs'}</span>
        <ArrowRight className="w-4 h-4 ml-2" />
      </Button>
    </a>
  </div>
</div>

