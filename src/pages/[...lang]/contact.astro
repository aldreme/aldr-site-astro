---
import '@/styles/globals.css';

import { BreadcrumbResponsive, type BreadcrumbData } from '@/components/breadcrumb';
import { ContactForm } from '@/components/contact/contact-form';
import PageLayout from '@/layouts/page-layout.astro';
import { Mail, MapPin, Phone } from 'lucide-react';

import { useTranslations } from '@/i18n/ui';
import { getLocalizedRoute } from '@/i18n/utils';
import { supabase } from "@/lib/supabase";

export async function getStaticPaths() {
  return [
    { params: { lang: undefined } },
    { params: { lang: 'zh' } },
  ];
}

const { lang } = Astro.params;
const currentLang = lang || 'en';
const t = useTranslations(currentLang as any);

const breadcrumbData: BreadcrumbData = {
  items: [
    { href: getLocalizedRoute("/", currentLang), label: t('navbar-home') || "Home" },
    { label: t('contact-page-title') || "Contact Us" },
  ]
}

// Default contact info (fallback)
let contactInfo = {
  address: "67 Youming Road, Suzhou, Jiangsu, China, 215222",
  tel_us: "+1 (617) 356-8065",
  tel_cn: "+86 18051120028",
  email: "sales@aldreme.com"
};

try {
  const { data } = await supabase.from('site_config').select('value').eq('key', 'contact_info').single();
  if (data) {
    // Merge with default to ensure all keys exist if partial data is returned
    contactInfo = { ...contactInfo, ...data.value };
  }
} catch (e) {
  console.error("Error fetching site config", e);
}

const pageTitle = t('contact-page-title') || "Contact Us";
const pageSubtitle = t('contact-page-subtitle') || "Get in touch with our engineering team for product specifications, custom fabrication requests, or general inquiries.";
---

<PageLayout pageTitle={pageTitle} lang={currentLang}>
  <div class="bg-zinc-50 min-h-screen pb-20">
    {/* Header */}
    <div class="bg-white border-b border-zinc-200">
      <div class="container mx-auto px-4 py-8">
        <BreadcrumbResponsive data={breadcrumbData} client:visible />
        <div class="mt-8 mb-4">
          <h1 class="text-4xl font-bold tracking-tight text-zinc-900 sm:text-5xl mb-4">
            {pageTitle}
          </h1>
          <p class="text-lg text-zinc-600 max-w-2xl">
            {pageSubtitle}
          </p>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-12">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        {/* Left Column: Contact Info & Map */}
        <div class="lg:col-span-5 space-y-8">
          {/* Contact Details Card */}
          <div class="bg-white rounded-xl border border-zinc-200 shadow-sm p-6 space-y-6">
            <h3 class="font-bold text-zinc-900 text-lg">{t('contact-info-title') || "Contact Information"}</h3>
            
            <div class="flex items-start space-x-3">
              <MapPin className="w-5 h-5 text-blue-600 mt-1 shrink-0" />
              <div>
                <p class="font-medium text-zinc-900">{t('address-label') || "Address"}</p>
                <p class="text-zinc-600 text-sm leading-relaxed">
                  <span set:html={contactInfo.address} />
                </p>
              </div>
            </div>

            <div class="flex items-start space-x-3">
              <Phone className="w-5 h-5 text-blue-600 mt-1 shrink-0" />
              <div>
                <p class="font-medium text-zinc-900">{t('phone-label') || "Phone"}</p>
                <p class="text-zinc-600 text-sm">{contactInfo.tel_us} (USA)</p>
                <p class="text-zinc-600 text-sm">{contactInfo.tel_cn} (China)</p>
              </div>
            </div>

            <div class="flex items-start space-x-3">
              <Mail className="w-5 h-5 text-blue-600 mt-1 shrink-0" />
              <div>
                <p class="font-medium text-zinc-900">{t('email-label') || "Email"}</p>
                <p class="text-zinc-600 text-sm">{contactInfo.email}</p>
              </div>
            </div>
          </div>

          {/* Map */}
          <div class="bg-white rounded-xl border border-zinc-200 shadow-sm overflow-hidden h-[300px] lg:h-[400px]">
             <iframe 
                src="https://www.google.com/maps/embed?pb=!1m17!1m12!1m3!1d718.2006237789999!2d120.65961086953573!3d31.099803554263595!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m2!1m1!2zMzHCsDA1JzU5LjQiTiAxMjDCsDM5JzM0LjciRQ!5e0!3m2!1sen!2sca!4v1741497475247!5m2!1sen!2sca" 
                width="100%" 
                height="100%" 
                style="border:0;" 
                allowfullscreen="" 
                loading="lazy" 
                referrerpolicy="no-referrer-when-downgrade"
                class="w-full h-full"
              ></iframe>
          </div>
        </div>

        {/* Right Column: Contact Form */}
        <div class="lg:col-span-7">
           <ContactForm client:visible lang={currentLang} />
        </div>
      </div>
    </div>
  </div>
</PageLayout>
