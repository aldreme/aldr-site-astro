---
import '@/styles/globals.css';

import { BreadcrumbResponsive, type BreadcrumbData } from '@/components/breadcrumb';
import ProductCarousel from '@/components/products/product-carousel';
import { ProductDescriptionCard } from '@/components/products/product-description-card';
import { ProductTechSpecs } from '@/components/products/product-tech-specs';
import type { ProductData } from '@/components/products/types';
import { useTranslations } from '@/i18n/ui'; // Import translations
import { getLocalizedRoute, getProductTranslation } from '@/i18n/utils'; // Import utils
import PageLayout from '@/layouts/page-layout.astro';
import { supabase } from "@/lib/supabase";

export async function getStaticPaths() {
  const { data: products } = await supabase.from('products').select('*');
  const paths = [];

  // Generate paths for both languages
  products?.forEach((product) => {
    // English path (lang undefined)
    paths.push({
      params: { lang: undefined, slug: product.slug },
      props: { productData: product as unknown as ProductData }
    });
     // Chinese path (lang 'zh')
    paths.push({
      params: { lang: 'zh', slug: product.slug },
      props: { productData: product as unknown as ProductData }
    });
  });

  return paths;
}

interface Props {
  productData: ProductData;
};

const { lang } = Astro.params;
const currentLang = lang || 'en';
const t = useTranslations(currentLang as any);

// Translate product data using our helper
const rawProductData = Astro.props.productData;
const translatedFields = getProductTranslation(rawProductData, currentLang);
const productData = { 
  ...rawProductData, 
  ...translatedFields 
};


// Construct remote image URIs
const productImageUri = productData.images?.map(img => {
    if (img.startsWith('http')) return img;
    return `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/products/${img}`;
}) || [];

const breadcrumbData: BreadcrumbData = {
  items: [
    { href: getLocalizedRoute("/", currentLang), label: t('navbar-home') || "Home" },
    { href: getLocalizedRoute("/products", currentLang), label: t('navbar-products') || "Products" },
    { label: productData.name },
  ]
}

const keywords = [
  ...productData.tags || [],
  productData.category,
  productData.name,
  "Stainless Steel",
  "Cleanroom Equipment",
  "Laboratory Furniture"
].filter(Boolean).join(", ");

const seoDescription = productData.introduction || productData.description;
const productJsonLd = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": productData.name,
  "description": seoDescription,
  "image": productImageUri,
  "brand": {
    "@type": "Brand",
    "name": "ALDR EME"
  },
  "offers": {
    "@type": "Offer",
    "url": Astro.url.href,
    "priceCurrency": "USD",
    // "price": "0", // Optional: Add price if available
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition"
  },
  "category": productData.category,
  "material": productData.specs?.material?.value || "Stainless Steel"
};
---

<PageLayout 
  pageTitle={productData.name}
  seoDescription={seoDescription}
  seoImage={productImageUri[0]}
  seoType="product"
  seoJsonLd={productJsonLd}
  seoKeywords={keywords}
  lang={currentLang}
>
  <div class="bg-zinc-50 min-h-screen pb-20">
    {/* Breadcrumb Section */}
    <div class="bg-white border-b border-zinc-200">
      <div class="container mx-auto px-4 py-4">
        <BreadcrumbResponsive data={breadcrumbData} client:visible />
      </div>
    </div>

    <div class="container mx-auto px-4 py-8 md:py-12">
      {/* Top Section: Carousel + Quick Info + RFQ */}
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        {/* Left Column: Images */}
        <div class="lg:col-span-7 space-y-8">
          <div class="bg-white rounded-xl shadow-xs border border-zinc-200 p-4">
            <ProductCarousel client:visible
              productImageUris={productImageUri}
              className='w-full aspect-4/3 object-contain rounded-lg'
            />
          </div>

          {/* Product Intro - moved here for better flow on mobile/desktop */}
          <div class="prose prose-zinc max-w-none">
            <h2 class="text-2xl font-bold text-zinc-900 mb-4">{t('product-overview') || "Product Overview"}</h2>
            <p class="text-zinc-600 leading-relaxed">
              {productData.introduction}
            </p>
          </div>
          
          {/* Applications */}
          <div>
            <h3 class="text-xl font-bold text-zinc-900 mb-4">{t('application-scenarios') || "Application Scenarios"}</h3>
            <ul class="grid grid-cols-1 md:grid-cols-2 gap-3">
              {
                productData.application_scenarios.map((scenario) => (
                  <li class="flex items-start text-zinc-600 bg-white p-3 rounded-lg border border-zinc-100 shadow-xs">
                    <span class="mr-2 text-blue-600">â€¢</span>
                    {scenario}
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        {/* Right Column: Key Features & RFQ */}
        <div class="lg:col-span-5">
          <div class="sticky top-24">
            <ProductDescriptionCard client:visible
              productName={productData.name}
              image={productImageUri[0]}
              productDescription={productData.description}
              productFeatures={productData.features}
              className="bg-white rounded-xl shadow-sm border border-zinc-200 p-6"
              lang={currentLang}
            />
          </div>
        </div>
      </div>

      {/* Tech Specs Section */}
      <div class="mt-16">
        <div class="flex items-center justify-between mb-8 border-b border-zinc-200 pb-4">
          <h2 class="text-2xl font-bold text-zinc-900">{t('technical-specifications') || "Technical Specifications"}</h2>
          <span class="text-sm text-zinc-500 font-mono">Ref: {productData.name.toUpperCase().replace(/\s+/g, '-')}</span>
        </div>
        <ProductTechSpecs productTechSpecs={productData.specs} client:visible lang={currentLang} />
      </div>

      {/* Policies Section */}
      <div class="mt-16 grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-zinc-600 border-t border-zinc-200 pt-12">
        <div>
          <h3 class="font-bold text-zinc-900 mb-2">{t('shipping-information') || "Shipping Information"}</h3>
          <p>{productData.policies.shipping}</p>
        </div>
        <div>
          <h3 class="font-bold text-zinc-900 mb-2">{t('warranty-support') || "Warranty Support"}</h3>
          <p>{productData.policies.warranty}</p>
        </div>
      </div>
    </div>
  </div>
</PageLayout>
