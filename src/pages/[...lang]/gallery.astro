---
import GalleryMasonry from '@/components/gallery/GalleryMasonry';
import PageLayout from '@/layouts/page-layout.astro';
import { useTranslations } from '@/i18n/ui';

// Fetch images from Supabase storage
import { supabase } from '@/lib/supabase';

export async function getStaticPaths() {
  return [
    { params: { lang: undefined } },
    { params: { lang: 'zh' } },
  ];
}

const { lang } = Astro.params;
const currentLang = lang || 'en';
const t = useTranslations(currentLang as any);

const { data: files } = await supabase.storage.from('product-gallery').list();

const images = files ? files.map((file) => {
  const filename = file.name.split('.')[0] || 'Product Image';
  // Clean up filename for alt text
  const alt = filename
    .replace(/^s-blob-v1-IMAGE--/, '')
    .replace(/^s-blob-v1-IMAGE-/, '')
    .replace(/-/g, ' ')
    .replace(/_/g, ' ')
    .trim();

  return {
    src: `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/product-gallery/${file.name}`,
    alt: alt || 'Product Image',
    // Dimensions not available from storage list
  };
}).filter(img => !img.src.endsWith('.emptyFolderPlaceholder')) : [];

const pageTitle = t('gallery-title') || "Product Gallery";
const pageSubtitle = t('gallery-subtitle') || "Explore our collection of high-precision stainless steel equipment and laboratory solutions. Each piece is engineered to meet the highest standards of durability and hygiene.";
---

<PageLayout pageTitle={pageTitle} lang={currentLang}>
  <div class="bg-zinc-50 dark:bg-zinc-950 min-h-screen py-24 sm:py-32">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mb-16 px-4">
        <h1 class="text-4xl font-extrabold tracking-tight text-zinc-900 dark:text-white sm:text-6xl mb-6">
          {pageTitle}
        </h1>
        <p class="text-lg leading-8 text-zinc-600 dark:text-zinc-400">
          {pageSubtitle}
        </p>
      </div>

      <div class="px-4">
        {images.length > 0 ? (
          <GalleryMasonry images={images} client:load />
        ) : (
          <div class="text-center py-20 bg-white rounded-2xl border border-zinc-200 shadow-sm">
            <p class="text-zinc-500">{t('no-images-found') || "No images found in the gallery."}</p>
            <p class="text-sm text-zinc-400 mt-2">{t('check-storage-bucket') || "Please check Supabase Storage 'product-gallery' bucket."}</p>
          </div>
        )}
      </div>
    </div>
  </div>
</PageLayout>
